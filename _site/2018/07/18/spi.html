<!doctype html>
<html dir="rtl" lang="ar-SA">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>بروتوكول الإتصال المتزامن SPI | لنتعلم برمجة الأنظمة المدمجة</title>
<meta property="og:title" content="بروتوكول الإتصال المتزامن SPI" />
<meta name="author" content="خالد الغامدي" />
<meta property="og:locale" content="ar_SA" />
<meta name="description" content="الواجهة الطرفية التسلسلية Serial Peripheral Interface - SPI هي بروتوكول بيانات متسلسلة serial ومتزامنة synchronous تستخدمه المتحكمات للتواصل مع جهاز طرفي واحد أو أكثر أو مع متحكم آخر بسرعة نقل بيانات عالية وعبر مسافات قصيرة." />
<meta property="og:description" content="الواجهة الطرفية التسلسلية Serial Peripheral Interface - SPI هي بروتوكول بيانات متسلسلة serial ومتزامنة synchronous تستخدمه المتحكمات للتواصل مع جهاز طرفي واحد أو أكثر أو مع متحكم آخر بسرعة نقل بيانات عالية وعبر مسافات قصيرة." />
<link rel="canonical" href="http://localhost:4000/2018/07/18/spi.html" />
<meta property="og:url" content="http://localhost:4000/2018/07/18/spi.html" />
<meta property="og:site_name" content="لنتعلم برمجة الأنظمة المدمجة" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2018-07-18T00:00:00+03:00" />
<script type="application/ld+json">
{"name":null,"description":"الواجهة الطرفية التسلسلية Serial Peripheral Interface - SPI هي بروتوكول بيانات متسلسلة serial ومتزامنة synchronous تستخدمه المتحكمات للتواصل مع جهاز طرفي واحد أو أكثر أو مع متحكم آخر بسرعة نقل بيانات عالية وعبر مسافات قصيرة.","author":{"@type":"Person","name":"خالد الغامدي"},"@type":"BlogPosting","url":"http://localhost:4000/2018/07/18/spi.html","publisher":null,"image":null,"headline":"بروتوكول الإتصال المتزامن SPI","dateModified":"2018-07-18T00:00:00+03:00","datePublished":"2018-07-18T00:00:00+03:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2018/07/18/spi.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script type="text/javascript" src="/assets/js/jquery-1.12.4.min.js" ></script>
    <script type="text/javascript" src="/assets/js/main.js"></script>
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>لنتعلم برمجة الأنظمة المدمجة</h1>
		<h3 text-align="left">Embedded Systems Programming Bootcamp</h3>
        <p>كورس تعليمي يهدف الى اكسابك المعرفة اللازمة والمهارات التقنية المتعلقة ببرمجة وتطوير الأنظمة المدمجة وفهم خصائصها ومكوناتها</p>
        <p class="view">
            <a href="/">الصفحة الرئيسية</a><br>
            <!--<a href="/#contents">الدروس</a><br>-->
            <a href="/lessons.html">قائمة الدروس</a><br>
            <a href="/feed.xml" title="Subscribe to our RSS feed">خدمة RSS</a>
        </p>
        <!--/assets/images/sidebar/rss.svg-->
          <!--<aside>-->
    <h3>للتواصل</h3>
    <ul class="social">
    <li><a href="https://github.com/alhabish/embedded-course" title="Github" class="github">Github</a></li>
    <li><a href="mailto:alhabish@gmail.com" title="Email" class="mail">Email</a></li>
    <li><a href="https://www.linkedin.com/in/khalidalghamidi" title="Linked in" class="linked">LinkedIn</a></li>
    <li><a href="http://www.twitter.com/alhabish" title="Twitter" class="twitter">Twitter</a></li>
    </ul>
    <!--</aside>-->
          
<!--        
        

        

        
-->
      </header>
      <section>

      <h1>12. بروتوكول الإتصال المتزامن SPI</h1>
<p class="meta">2018-07-18</p>


<!-- from https://github.com/cstack/db_tutorial -->


      
      

    <hr>
      
          <a class="prev" href="/2018/08/17/i2c.html">13. بروتوكول الإتصال المتزامن I2C</a> <br>
      
      
          <a class="next" href="/2018/07/06/uart.html">11. بروتوكول الإتصال الغير متزامن UART</a> <br>
      
    <br>
    <hr>

    <p><p>الواجهة الطرفية التسلسلية Serial Peripheral Interface - SPI هي بروتوكول بيانات متسلسلة serial ومتزامنة synchronous تستخدمه المتحكمات للتواصل مع جهاز طرفي واحد أو أكثر أو مع متحكم آخر بسرعة نقل بيانات عالية وعبر مسافات قصيرة.</p>

<p>أحد المزايا الرئيسية لـ SPI هو أنه يوفر معدل نقل بيانات أعلى من UART و I2C ويستخدم عند الحاجة إلى اتصال تسلسلي عالي السرعة. يمكنك أيضًا إرسال المزيد من المعلومات لكل عملية نقل بيانات ولكن يعيبها حاجتها الى المزيد من الأطراف عن تلك التي بـ UART و I2C.</p>

<hr />

<h2><a href=""></a> الهاردوير</h2>

<p>في الـ SPI هناك دائمًا جهاز رئيسي واحد (عادةً ما يكون المتحكم) يتحكم في الأجهزة الطرفية. وعادة ما يكون هنالك ثلاثة خطوط مشتركة بين جميع الأجهزة:</p>

<p><strong>1. SCLK - Serial Clock</strong></p>

<p>تحدد الساعة معدل نقل البيانات وينقل هذا الخط نبضات الساعة التي تعمل على تزامن نقل البيانات التي تم إنشاؤها بواسطة الطرف الرئيسي. كل بت من البيانات يتم نقله على هذا الخط تتزامن وتتوافق مع إشارة أو نبضة واحدة للساعة. والهدف من ذلك هو تمكين المتلقي من إستقبال البتات في الرسالة بنفس المعدل الذي تم نقلها عليه للتأكد من عدم ضياع أية بت وليتمكن المستقبل  من تفسيرها بشكل صحيح.</p>

<p><strong>2. MOSI - Master Out Slave In</strong></p>

<p>يستخدمه الجهاز الرئيسي لإرسال البيانات إلى الأجهزة الطرفية. ويتم إرسال البت الأعلى most significant bit أولاً.</p>

<p><strong>3. MISO - Master In Slave Out</strong></p>

<p>يتلقى الجهاز الرئيسي البيانات من الأجهزة الطرفية عبر هذا الخط. ويتم إستقبال البت الأعلى most significant bit أولاً.</p>

<p>وهنالك خط واحد خاص بكل جهاز فرعي ويكون متصلاً بالجهاز الرئيسي:</p>

<p><strong>4. SS - Slave Select</strong></p>

<p>يتم تبليغ الجهاز الفرعي على هذا الخط بأن عليه الاستعداد لتلقي البيانات وبأنه هو المعني بإستقبال هذه البيانات. هناك طرف pin منفصل لكل جهاز فرعي متصل بالجهاز الرئيسي. في الحالة العادية تكون إشارة هذا الخط عالية (1) ومتى ما أردنا التواصل مع أحد الأطراف فكل ما علينا فعله هو جعل قيمة الخط الخاص بالجهاز الطرفي منخفضه (0) ثم رفعها مرة أخرى بعد الإنتهاء من عملية الإرسال.</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/table_15_1.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/table_15_1.png');" />
    </td>
</tr>
</table>

<p>الرسم التوضيحي التالي يمثل الاتصال بين جهاز رئيسي وجهاز فرعي واحد:</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/single_slave.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/single_slave.png');" />
    </td>
</tr>
</table>

<p>أما إذا كان لدينا أكثر من جهاز فرعي واحد، فإن ثلاثة من الخطوط ستكون متصلة بجميع الأطراف: SCLK و MOSI و MISO، بينما سيكون لكل طرف خط SS واحد:</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/multi_slave3.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/multi_slave3.png');" />
    </td>
</tr>
</table>

<hr />

<h2><a href=""></a> الساعة</h2>

<p>SPI هو ناقل بيانات “متزامن” synchronous، مما يعني أنه يستخدم خطوط منفصلة للبيانات و خط للساعة لتحافظ على تزامن كلا الجانبين. ونظرًا الى أن الساعة يتم إرسالها في خط مستقل مع البيانات، فإنه لا يتوجب علينا توحيد سرعة نقل البيانات للمرسل والمستقبل كما فعلنا في الـ UART.</p>

<p>الساعة عبارة عن إشارة تتأرجح oscillating بإستمرار تخبر الطرف المستقبل متى عليه بالضبط أخذ عينات sample للبتات على خط البيانات. قد تؤخذ العينة عند إرتفاع (منخفض إلى مرتفع) أو سقوط (مرتفع إلى منخفض) حافة إشارة الساعة. عندما يكتشف المستقبِل هذه الحافة، فإنه سينظر على الفور إلى خط البيانات لقراءة البت bit التالي.</p>

<p>طرف واحد فقط يولد إشارة الساعة يسمى الطرف “الرئيسي” master، والجانب الآخر يسمى بالطرف “الفرعي” slave. هناك دائمًا طرف رئيسي واحد فقط (وهو دائمًا ما يكون المتحكم الخاص بك)، ولكن يمكن أن يكون هنالك العديد من الأطراف الفرعية. ونظرًا لأن الطرف الرئيسي هو الوحيد الذي يمكنه أن يولًد الساعة فإنه هو من يحدد وقت حدوث جميع العمليات على البيانات.</p>

<p>عندما يتم إرسال البيانات من الطرف الرئيسي للفرعي، يتم إرسالها على خط بيانات يسمى MOSI، أو “Master Out / Slave In”. وإذا احتاج الطرف الفرعي إلى إرسال رد إلى الطرف الرئيسي، فسوف يستمر الطرف الرئيسي في توليد عدد محدد مسبقًا من دورات الساعة، وسيضع الطرف الفرعي بياناته على خط بيانات ثالث يسمى MISO، أو “Master In / Slave Out”.</p>

<p>لا يمكن للجهاز الطرفي أن يرسل للرئيسي بيانات كيفما يشاء، بل لابد أن يكون ذلك محدداً ومعروفاً مسبقاً من قبل الجهاز الرئيسي فيما اذا ما كان سيقوم الجهاز الطرفي بالإجابة على رسالة أرسلها الجهاز الرئيسي وماهو حجم هذه البيانات. وذلك لأن الجهاز الرئيسي هو وحده من يولد الساعة. هذا السيناريو يختلف كثيرا عن الإرسال الغير المتزامن asynchronous، حيث يمكن إرسال كميات عشوائية من البيانات في أي اتجاه وفي أي وقت. ولكن في الواقع لا يشكل هذا الأمر عائقاً كبيراً من الناحية العملية، حيث أن SPI تستخدم عادة للتواصل مع المستشعرات sensors التي لها بنية أوامر محددة ومعروفة مسبقاً. على سبيل المثال، إذا أرسلت أمرًا لـ “قراءة البيانات” إلى جهاز ما، فستعلم أن الجهاز سيرد عليك دائمًا بـ 2 بايت من البيانات في المقابل. أما في الحالات التي قد ترغب فيها بإرجاع كمية متغيرة من البيانات، يمكنك دائمًا إرجاع بايت واحد تحدد فيه طول البيانات القادمة، وعلى ذلك يمكن للطرف الرئيسي إسترجاع كامل البيانات المرسله اليه.</p>

<hr />

<h2><a href=""></a> أنماط الـ SPI</h2>

<p>عندما يتصل جهازان معاً عن طريق الـ SPI فهنالك أمران مهمان يجب عليهما أن يتفقان عليه:</p>

<ul>
  <li>ما هو وضع الساعة في فترات عدم النشاط؟</li>
  <li>ومتى يفترض أخذ عينات البيانات؟</li>
</ul>

<p>ويشار إلى هاتين الخاصيتين عادة باسم قطبية الساعة clock polarity وطور الساعة clock phase على التوالي.</p>

<p>تحدد قطبية الساعة clock polarity ما إذا كان وضع الساعة منخفض 0 أو مرتفع 1 عند عدم إرسال البيانات (الحالة الغير نشطة)؛ بمعنى هل الساعة غير نشطة عندما تكون مرتفعة أم منخفضة؟ إذا تم ضبط القطبية polarity على 0، فسيكون وضع الساعة منخفض 0 عندما تكون غير نشطة. وعندما تكون القطبية 1 سيكون وضع الساعة 1 عندما تكون غير نشطة.</p>

<p>ويشير طور الساعة clock phase إلى الحافة التي سيقوم فيها الجهاز بمعاينة البايت الأول من البيانات. ما إذا كان نقل البيانات على الحافة الصاعدة أو المتساقطة لإشارة الساعة. إذا كان الطور يساوي 0، فسيتم معاينة البيانات على الحافة الأولى من الساعة. أما إذا كان الطور يساوي 1، فسيتم معاينة البيانات على الحافة الثانية من الساعة.</p>

<p>هناك 4 أوضاع مختلفة في SPI وهي MODE0 و MODE1 و MODE2 و MODE3. وهي تعتمد على أنه يمكنك تحديد بالضبط كيف يتم بالضبط معاينة البت وذلك على أساس موضع إشارة الساعة. هناك جزءان من الساعة يجب أن تضعه في اعتبارك، قطبية الساعة CPOL وطور الساعة CPHA.</p>

<p>عندما يكون CPOL = 0 فذلك يعني أنه سيتم ضبط الساعة إلى مستوى منخفض وعندما تبدأ فعليًا بالإرسال فإن الإشارة ستبدأ من الوضع المنخفض ومن ثم مرتفعة ومن ثم منخفضة وهكذا. وعندما يكون CPOL = 1 فذلك يعني أنه سيتم ضبط الساعة فعليًا على الوضع المرتفع، وعندما نبدأ فعليًا في بالإرسال، فإن الإشارة ستنخفض ثم ترتفع ثم تنخفض وهكذا.</p>

<p>يحدد CPHA ما إذا كان سيتم معاينة الإشارة في التغيير الأول للساعة أو التغيير الثاني للساعة. لذلك عندما CPHA = 0 يعني أن البت يتم تحديده على أول تغيير للساعة. وعندما يكون CPHA = 1 فذلك يعني أنه سيتم معاينة البت على التغيير الثاني للساعة وذلك عندما تنتقل الإشارة من مرتفع إلى منخفض أو العكس.</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/cpol_cpha.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/cpol_cpha.png');" />
    </td>
</tr>
</table>

<p>باستخدام كل من القطبية polarity والطور phase، يمكننا تحديد 4 أنماط مختلفة لـ SPI (من 0 إلى 3) وفقًا لهذا الجدول:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">MODE</th>
      <th style="text-align: center">POLARITY - CPOL</th>
      <th style="text-align: center">PHASE - CPHA</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">1</td>
    </tr>
  </tbody>
</table>

<table style="border: 1px solid #CACFD2">

<caption align="bottom" style="text-transform: lowercase; font-style: italic; font-size: 0.8em">source: http://elm-chan.org/docs/spi_e.html</caption>
<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/spi_modes.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/spi_modes.png');" />
    </td>
</tr>
</table>

<hr />

<h2><a href=""></a> NOKIA 5110 LCD</h2>

<p>لتجربة الـ SPI سنستفيد من شاشة Nokia 5110 LCD. سنقوم أولا بتوصيل الشاشة بالمتحكم ثم تهيئة وإعداد الـ SPI.</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/lcd_front.jpg" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/lcd_front.jpg');" />
    </td>
</tr>
</table>

<p>تم استخدام شاشة Nokia 5110 LCD في هواتف Nokia 5110 المحمولة منذ عدة سنوات. وتحتوي الشاشة على 48 صفًا × 84 عمودًا من وحدات البكسل باستهلاك منخفض للطاقة حيث أنها قادرة على العمل من 2.7 فولت إلى 5 فولت، لذا فهي مناسبة جدًا للاستخدام في التطبيقات المدمجة. ويمكنك الحصول على دليل البيانات على العنوان التالي:</p>

<p><a href="https://www.sparkfun.com/datasheets/LCD/Monochrome/Nokia5110.pdf">Nokia 5110 Datasheet</a></p>

<p>سيتم توصيل المتحكم بالشاشة على النحو التالي:</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/lcd_back.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/lcd_back.png');" />
    </td>
</tr>
</table>

<table>
  <thead>
    <tr>
      <th style="text-align: right">الخط</th>
      <th style="text-align: right">Nokia 5110</th>
      <th style="text-align: right">TM4C123</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><strong>3.3V</strong></td>
      <td style="text-align: right">(VCC, pin 1)</td>
      <td style="text-align: right">power</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Ground</strong></td>
      <td style="text-align: right">(GND, pin 2)</td>
      <td style="text-align: right">ground</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>SSI0Fss</strong></td>
      <td style="text-align: right">(SCE, pin 3)</td>
      <td style="text-align: right">PA3</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Reset</strong></td>
      <td style="text-align: right">(RST, pin 4)</td>
      <td style="text-align: right">PA7</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Data/Command</strong></td>
      <td style="text-align: right">(D/C, pin 5)</td>
      <td style="text-align: right">PA6</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>SSI0Tx</strong></td>
      <td style="text-align: right">(DN,  pin 6)</td>
      <td style="text-align: right">PA5</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>SSI0Clk</strong></td>
      <td style="text-align: right">(SCLK, pin 7)</td>
      <td style="text-align: right">PA2</td>
    </tr>
  </tbody>
</table>

<p>وتكون بالطريقة التالية:</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/TivaC_NokiaLCD.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/TivaC_NokiaLCD.png');" />
    </td>
</tr>
</table>

<hr />

<h2><a href=""></a> إرسال أوامر أو بيانات الى الشاشة</h2>

<p>كما هو مذكور في دليل البيانات الخاص بالشاشة، قبل إرسال البيانات أو الأوامر إلى الشاشة، نحتاج إلى جعل الطرف CE منخفضًا وجعله مرتفعًا مرة أخرى بعد إرسال الأمر. أيضا، نحن بحاجة إلى جعل الطرف DC منخفض 0 للأوامر ومرتفع 1 للبيانات.</p>

<p>سأقوم هنا فقط بتغطية الأوامر التي سنستخدمها في برنامجنا ويمكنك الرجوع إلى دليل البيانات للمزيد من التفاصيل.</p>

<p>هناك مجموعتان من الأوامر:</p>

<ol>
  <li>مجموعة الأوامر الموسعة Extended Command Set وهي تلك المستخدمة في تهيئة طريقة عمل الشاشة، مثل التباين، زاوية العرض، إلخ.</li>
  <li>مجموعة الأوامر الأساسية Basic Command Set وتستخدم لتعيين وضع العرض وموضع عرض البيانات.</li>
</ol>

<p>تتبع عملية التهيئة وإرسال الأوامر التسلسل التالي:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">Command</th>
      <th style="text-align: right">Value</th>
      <th style="text-align: right">Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><strong>Extended Command</strong></td>
      <td style="text-align: right">0x21</td>
      <td style="text-align: right">Set to EXTENDED command mode (Chip activated, horizontal addressing)</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Vlcd Voltage</strong></td>
      <td style="text-align: right">0xb2</td>
      <td style="text-align: right">Set Vlcd (Contrast) to 6v</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Voltage Bias</strong></td>
      <td style="text-align: right">0x13</td>
      <td style="text-align: right">Set voltage bias (viewing angle) to n=4, 1:48</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Basic Command</strong></td>
      <td style="text-align: right">0x20</td>
      <td style="text-align: right">Set to NORMAL command mode</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>All Pixels ON</strong></td>
      <td style="text-align: right">0x09</td>
      <td style="text-align: right">Turn on all pixels</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Display mode</strong></td>
      <td style="text-align: right">0x0c</td>
      <td style="text-align: right">Set display to Normal mode</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Addressing Y</strong></td>
      <td style="text-align: right">01000yyy</td>
      <td style="text-align: right">Addressing row with yyy</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Addressing X</strong></td>
      <td style="text-align: right">1xxxxxxx</td>
      <td style="text-align: right">Addressing columns with xxxxxxx</td>
    </tr>
  </tbody>
</table>

<hr />

<h2><a href=""></a> تهيئة الـ SPI</h2>

<p>إذا فتحنا صفحة 965 في دليل البيانات، فإنه بإمكاننا العثور على الخطوات المطلوبة لتهيئة الـ SPI وهي:</p>

<p><strong>1. قم بتمكين وحدة الـ SSI باستخدام سجل RCGCSSI (راجع صفحة 346).</strong></p>

<p>لنتمكن من استخدام أي من الوحدات الطرفية في المتحكم، يجب علينا تمكين الساعة لها. نستخدم سجل RCGCSSI لتمكين الساعة للـ SSI.</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/RCGCSSI.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/RCGCSSI.png');" />
    </td>
</tr>
</table>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define SYSCTL_RCGCSSI_R   (*((volatile unsigned long *)0x400FE61C))
</span></code></pre>
</div>

<p>نقوم هنا بإسناد 1 الى حقل R0 (بت 0) لتمكين SSI0.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SYSCTL_RCGCSSI_R</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">);</span>
</code></pre>
</div>

<p><strong>2. قم بتمكين ساعة وحدة الـ GPIO المناسبة عبر سجل RCGCGPIO (انظر صفحة 340). لمعرفة أي منفذ GPIO يجب عليك تمكينه، راجع الجدول 5-23 في الصفحة 1351.</strong></p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/RCGCGPIO.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/RCGCGPIO.png');" />
    </td>
</tr>
</table>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define SYSCTL_RCGCGPIO_R   (*((volatile unsigned long *)0x400FE608))
</span></code></pre>
</div>

<p>يمكننا أن نرى أن SPI 0 يستخدم المنفذ  PORT A.</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/table_23_5.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/table_23_5.png');" />
    </td>
</tr>
</table>

<p>وبالعودة إلى سجل RCGCGPIO، يتضح أنه لتمكين PORT A علينا تعيين 1 إلى الحقل R0 (بت 0)</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SYSCTL_RCGCGPIO_R</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">);</span>
</code></pre>
</div>

<p><strong>3. ﻗﻢ ﺑﻀﺒﻂ بتات GPIOAFSEL ﻟلأطراف ﺍﻟﻤﻨﺎﺳﺒﺔ (ﺍﻧﻈﺮ ﺻﻔﺤﺔ ٦٧١). لتحديد أي GPIO يجب علينا ضبط إعداداته، راجع جدول 4-23 في الصفحة 1344.</strong></p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/GPIOAFSEL.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/GPIOAFSEL.png');" />
    </td>
</tr>
</table>

<p>وسبق وأن حددنا المنفذ الذي سنتعامل معه وهو PORT A.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define GPIO_PORTA_AFSEL_R   (*((volatile unsigned long *)0x40004420))
</span></code></pre>
</div>

<p>لتمكين الوظائف البديلة لـلمنافذ PA2 و PA3 و PA5، نقوم بإسناد 1 الى البت الذي يقابلها في حقل AFSEL</p>

<table>
  <thead>
    <tr>
      <th style="text-align: right">السجل</th>
      <th style="text-align: right">الطرف</th>
      <th style="text-align: right">AFSEL</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: right"><strong>SSI0Fss</strong></td>
      <td style="text-align: right">PA3</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Reset</strong></td>
      <td style="text-align: right">PA7</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>Data/Command</strong></td>
      <td style="text-align: right">PA6</td>
      <td style="text-align: right">0</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>SSI0Tx</strong></td>
      <td style="text-align: right">PA5</td>
      <td style="text-align: right">1</td>
    </tr>
    <tr>
      <td style="text-align: right"><strong>SSI0Clk</strong></td>
      <td style="text-align: right">PA2</td>
      <td style="text-align: right">1</td>
    </tr>
  </tbody>
</table>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">GPIO_PORTA_AFSEL_R</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span> <span class="c1">// enable alt funct
</span><span class="n">GPIO_PORTA_AFSEL_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">));</span> <span class="c1">// disable alt funct
</span></code></pre>
</div>

<p>إسناد القيمة 1 في سجل AFSEL يقوم بتمكين الوظيفة البديلة للطرف pin. الا أن هذا في حد ذاته لا يكفي حيث أن بعض الأطراف تدعم أكثر من وظيفة بديلة واحدة. وهنا ياتي دور سجل التحكم في المنفذ (PCTL) والذي نقوم فيه بتحديد بالضبط ماهي الوظيفة البديلة التي سيقوم بها المنفذ.</p>

<p><strong>4. قم بضبط إعدادات حقول PMCn في سجل GPIOPCTL لتعيين إشارات SSI إلى الأطراف المناسبة (انظر صفحة 688 والجدول 5-23 في الصفحة 1351).</strong></p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/GPIOPCTL.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/GPIOPCTL.png');" />
    </td>
</tr>
</table>

<p>نستخدم السجل register التالي للمنفذ PORT A:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define GPIO_PORTA_PCTL_R   (*((volatile unsigned long *)0x4000452C))
</span></code></pre>
</div>

<p>بمجرد تمكيننا للوظائف البديلة، يتعين علينا عندئذ اختيار الوظيفة البديلة المحددة التي نريدها. في الجدول 5-23 في صفحة 1351 في دليل البيانات يمكننا رؤية أن SSI0 يقع في العمود 2:</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/table_23_5.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/table_23_5.png');" />
    </td>
</tr>
</table>

<p>في هذا السجل كل 4 بت تمثل طرف، فالحقل PMC0 (بت0-3) يمثل الطرف 0، والحقل PMC1 (بت4-7) يمثل الطرف 1. وهكذا.</p>

<p>وكما ذكرنا سابقاً، بما أن SSI تقع في العمود رقم 2 فإننا نضع القيمة 2 في الحقول التي تمثل الأطراف التى نود تحويلها الى SPI:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="c1">//Configure PA2,3,5 as SPI
</span><span class="n">GPIO_PORTA_PCTL_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">GPIO_PORTA_PCTL_R</span> <span class="o">&amp;</span> <span class="mh">0xFF0F00FF</span><span class="p">)</span><span class="o">+</span><span class="mh">0x00202200</span><span class="p">;</span> 
</code></pre>
</div>

<p><strong>5. قم بتمكين الوظيفة الرقمية للطرف في السجل GPIODEN. راﺟﻊ “General-Purpose Input/Outputs - GPIOs” ﻓﻲ اﻟﺼﻔﺤﺔ ٦٤٩ ﻟﻠﺤﺼﻮل ﻋﻠﻰ اﻟﻤﺰﻳﺪ ﻣﻦ اﻟﻤﻌﻠﻮﻣﺎت.</strong></p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/GPIODEN.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/GPIODEN.png');" />
    </td>
</tr>
</table>

<p>وبما أنها إشارات رقمية فإنه يجب علينا تمكين الوظائف الرقمية للأطراف:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define GPIO_PORTA_DEN_R    (*((volatile unsigned long *)0x4000451C))
</span></code></pre>
</div>

<p>وهذا يكون كالتالي:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="c1">// enable digital I/O on PA2,3,5,6,7
</span><span class="n">GPIO_PORTA_DEN_R</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>
</code></pre>
</div>

<hr />

<h2><a href=""></a> ضبط إعدادات الـ SPI</h2>

<p>يتم ذلك باستخدام الخطوات التالية:</p>

<p><strong>1. تأكد من أن الحقل SSE (بت 1) في سجل SSICR1 يساوي 0 قبل إجراء أي تغييرات في الإعدادات</strong></p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/SSICR1.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/SSICR1.png');" />
    </td>
</tr>
</table>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define SSI0_CR1_R   (*((volatile unsigned long *)0x40008004))
</span></code></pre>
</div>

<p>نحن هنا نقوم فعلياً بإيقاف الـ SPI0 لضبط إعداداته ومن ثم تفعيله مرة أخرى. وذلك يكون على النحو التالي:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SSI0_CR1_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
</code></pre>
</div>

<p><strong>2. حدد ما إذا كان SPI للمتحكم الذي تقوم ببرمجته هو لجهاز رئيسي master أم فرعي slave:</strong></p>

<ul>
  <li>إذا كان رئيسي، اضبط سجل SSICR1 على 0x0000.0000</li>
  <li>إذا كان فرعي (مع تمكين المخرجات output enabled) ، اضبط سجل SSICR1 على 0x0000.0004</li>
  <li>إذا كان فرعي (مع عدم تمكين المخرجات output disabled) ، اضبط سجل SSICR1 على 0x0000.000C</li>
</ul>

<p>في برنامجنا هذا المتحكم هو الجهاز الرئيسي والشاشة فرعية ولذلك نقوم بإسناد القيمة  0x0000.0000 الى سجل SSICR1 في البرنامج الذي سنقوم بكتابته على المتحكم:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SSI0_CR1_R</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</code></pre>
</div>

<p><strong>3. ضبط مصدر ساعة SSI عن طريق الكتابة إلى سجل SSICC</strong></p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/SSICC.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/SSICC.png');" />
    </td>
</tr>
</table>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define SSI0_CC_R   (*((volatile unsigned long *)0x40008FC8))
</span></code></pre>
</div>

<p>الحقل CS (بت 3:0) في السجل SSICC يحدد مصدر الساعة المستخدم للـ SPI. سنقوم بإسناد القيمة 0x0 الى هذا السجل لتحديد الساعة الرئيسة كمصدر.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SSI0_CC_R</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
</code></pre>
</div>

<p><strong>4. ضبط القاسم المخصص للساعة بالكتابة الى سجل SSICPSR.</strong></p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/SSICPSR.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/SSICPSR.png');" />
    </td>
</tr>
</table>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define SSI0_CPSR_R   (*((volatile unsigned long *)0x40008010))
</span></code></pre>
</div>

<p>هذا السجل يساعدنا في تحديد سرعة نقل البيانات bit rate. وهي بناءاً على المعادلة التالية:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">Bit</span> <span class="n">Rate</span> <span class="o">=</span> <span class="n">SysClk</span> <span class="o">/</span> <span class="p">(</span><span class="n">CPSDVSR</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">SCR</span><span class="p">))</span>
</code></pre>
</div>

<p>حيث أن:</p>

<ul>
  <li>SysClk هو تردد الساعة المستخدمة. وبما أننا أستخدمنا ساعة النظام فإن ترددها 16 ميجاهيرتز</li>
  <li>CPSDVSR عبارة عن رقم زوجي بين 2 و 254 يتم تخزينه في حقل CPSDVSR (بت 7:0) في سجل SSICPSR</li>
  <li>SCR عدد بين 0 و 255 يتم تخزينه في حقل SCR (بت 15:8) في سجل SSICR0 (المزيد عن ذلك في الخطوة التالية)</li>
</ul>

<p>فلو كنا نريد أن تكون سرعة النقل 1 ميجابت في الثانية 1MBPS، فستكون المعادلة كما يلي:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>16000000 / (16 x (1+0))
</code></pre>
</div>

<p>وبذلك تكون CPSDVSR = 0x10 و SCR = 0x0 مما يعطينا 1000000 كيلوبت/ثانية أو 1 ميجابت/ثانية.</p>

<p><strong>5. أضبط سجل SSICR0 بالإعدادات التالية:</strong></p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/SSICR0.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/SSICR0.png');" />
    </td>
</tr>
</table>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define SSI0_CR0_R   (*((volatile unsigned long *)0x40008000))
</span></code></pre>
</div>

<ul>
  <li>معدل الساعة التسلسلية في حقل SCR (بت 15:8) في سجل SSICR0</li>
</ul>

<p>حسب ما ذكرنا سابقاً، فإن القيمة التي سنضعها في هذا الحقل هي 0x0</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SSI0_CR0_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0000FF00</span><span class="p">);</span>  <span class="c1">// SCR = 0
</span></code></pre>
</div>

<ul>
  <li>سنقوم باستخدام وضع Freescale SPI، ولذلك يجب علينا تحديد قطبية الساعة عن طريق الحقل SPO (بت 6) ومرحلة الساعة في السجل SPH (بت 7)</li>
</ul>

<p>سيتم إسناد القيمة 0 الى كليهما:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SSI0_CR0_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x00000040</span><span class="p">);</span>  <span class="c1">// SPO = 0 
</span><span class="n">SSI0_CR0_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x00000080</span><span class="p">);</span>  <span class="c1">// SPH = 0  
</span></code></pre>
</div>

<ul>
  <li>تحديد البرنوكول المستخدم: Freescale SPI أو TI SSF أو MICROWIRE في الحقل FRF (بت 5:4)</li>
</ul>

<p>كما ذكرنا، سنختار بروتوكول Freescale SPI وذلك عن طريق إسناد 0x0 الى الحقل FRF</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SSI0_CR0_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">SSI0_CR0_R</span><span class="o">&amp;~</span><span class="mh">0x00000030</span><span class="p">)</span><span class="o">+</span><span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// FRF = Freescale format
</span></code></pre>
</div>

<ul>
  <li>تحديد حجم البيانات المرسلة عن طريق الحقل DSS (بت 3:0)</li>
</ul>

<p>سنرسل 8 بت في كل مرة ولذلك نسند القيمة 0x7 الى هذا الحقل</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SSI0_CR0_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">SSI0_CR0_R</span><span class="o">&amp;~</span><span class="mh">0x0000000F</span><span class="p">)</span><span class="o">+</span><span class="mh">0x00000007</span><span class="p">;</span> <span class="c1">// DSS = 8-bit data
</span></code></pre>
</div>

<p><strong>6. سنتخطى هذه الخطوة</strong></p>

<p><strong>7. تمكين الـ SPI عن طريق إسناد 1 الى حقل SSE (بت 1) في سجل SSICR1</strong></p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="n">SSI0_CR1_R</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span>
</code></pre>
</div>

<hr />

<h2><a href=""></a> إرسال وإستقبال البيانات</h2>

<p>عند رغبتنا في تمكين القراءة أو الكتابة (الاتصال بشكل عام) في SPI فإنه يتم ضبط خط SS دائمًا الى الوضع المنخفض ويكون خط الساعة SCLK دائمًا ما يتحرك لأعلى ولأسفل لتتبع الوقت.</p>

<p>وعلى عكس الـ UART، فإنه لا يوجد بت للبدء أو للتوقف والتي تستخدم لتحديد بداية ونهاية قراءة البيانات وبذلك نكون قد وفرنا عدد البتات المرسلة ويكون جميعها مستخدم للبيانات فقط. أي أنه في نفس المدة الزمنية فإنه يمكن إرسال/إستقبال عدد أكبر من البيانات في SPI منها في الـ UART.</p>

<p>عملية النقل في SPI تشمل جميع البيانات التي يتم إرسالها بينما خط SS منخفض. وتتراوح طول كل حزمة بيانات data frame بين 4 و 16 بت وذلك حسب حجم البيانات الذي يتم تحديده في البرنامج. ويتم إرسال هذه الحزمة بدءاً بالبت الأعلى most significant bit.</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/spi_read.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/spi_read.png');" />
    </td>
</tr>
</table>

<p>تشير الأشكال السداسية أعلاه أنه يتم نقل بيانات على خط MOSI.</p>

<h2>إرسال البيانات</h2>

<p>عندما نريد نقل البيانات ، نقوم بتخزينها على SSIDR (سجل بيانات SSI).</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/SSIDR.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/SSIDR.png');" />
    </td>
</tr>
</table>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define SSI0_DR_R   (*((volatile unsigned long *)0x40008008))
</span></code></pre>
</div>

<p>نكتب على وجه التحديد إلى حقل Data والمكون من 16 بت (بت 16:0). وبما أننا نعمل مع بيانات من 8 بت، يجب علينا وضع البيانات في الـ 8 بتات الأولى من السجل وباقي السجل غير مستخدم.</p>

<p>قبل إرسال البيانات، نحتاج إلى التحقق من سجل SSISR للتأكد من أن الـ FIFO غير ممتلئ وجاهز لإرسال البايت التالي.</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_12/SSISR.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_12/SSISR.png');" />
    </td>
</tr>
</table>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="cp">#define SSI0_SR_R   (*((volatile unsigned long *)0x4000800C))
</span></code></pre>
</div>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">void</span> <span class="k">static</span> <span class="n">lcd_write_data</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">data</span><span class="p">){</span>
  <span class="k">while</span><span class="p">((</span><span class="n">SSI0_SR_R</span><span class="o">&amp;</span><span class="mh">0x00000002</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">){};</span> <span class="c1">// wait until transmit FIFO not full (TNF flag)
</span>  <span class="n">DC</span> <span class="o">=</span> <span class="n">DC_DATA</span><span class="p">;</span>
  <span class="n">SSI0_DR_R</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>                <span class="c1">// data out
</span><span class="p">}</span>
</code></pre>
</div>

<h2>إستقبال البيانات</h2>

<p>يُستخدم أيضًا SSIDR لإستقبال البيانات. وفي حالتنا، يحمل الجزء السفلي المكون من 8 بت البيانات المستلمة. وقبل قراءة البيانات، نتحقق مما إذا كان الـ FIFO ليس فارغًا وقد تلقى بيانات، ثم نقرأها من SSIDR.</p>

<p>في برنامجنا، لا نتلقى بيانات من الشاشة، ولكن لو كنا سنفعل ذلك فإننا سنقوم بشيء مشابه للتالي:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="kt">char</span> <span class="n">c</span><span class="p">;</span>
<span class="k">while</span><span class="p">((</span><span class="n">SSI0_SR_R</span><span class="o">&amp;</span><span class="mh">0x00000004</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// Wait until FIFO not empty (RNE flag)   
</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">SSI0_DR_R</span>  <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span> <span class="c1">// Read 8-bit data
</span></code></pre>
</div>

<hr />
<h2><a href=""></a> البرنامج</h2>

<p>فيما يخص التعامل مع الشاشة، تم الإستفادة من بعض الأكواد الموجودة في الصفحة التالية مع التعديل:</p>

<p><a href="http://users.ece.utexas.edu/~valvano/arm/index.htm">http://users.ece.utexas.edu/~valvano/arm/index.htm</a></p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code><span class="c1">// Parts of the code from:
// http://users.ece.utexas.edu/~valvano/arm/index.htm
</span>
<span class="cp">#include &lt;stdint.h&gt;
</span>
<span class="cm">/* ************************* Registers ************************ */</span>

<span class="cp">#define SYSCTL_RCGCSSI_R        (*((volatile unsigned long *)0x400FE61C))
#define SYSCTL_RCGCGPIO_R     	(*((volatile unsigned long *)0x400FE608))
#define GPIO_PORTA_AFSEL_R      (*((volatile unsigned long *)0x40004420))
#define GPIO_PORTA_DIR_R        (*((volatile unsigned long *)0x40004400))
#define GPIO_PORTA_DEN_R        (*((volatile unsigned long *)0x4000451C))
#define GPIO_PORTA_PCTL_R       (*((volatile unsigned long *)0x4000452C))
#define GPIO_PORTA_AMSEL_R      (*((volatile unsigned long *)0x40004528))
#define SSI0_CR1_R              (*((volatile unsigned long *)0x40008004))
#define SSI0_CC_R               (*((volatile unsigned long *)0x40008FC8))
#define SSI0_CPSR_R             (*((volatile unsigned long *)0x40008010))
#define SSI0_CR0_R              (*((volatile unsigned long *)0x40008000))
#define SSI0_SR_R               (*((volatile unsigned long *)0x4000800C))
#define SSI0_DR_R               (*((volatile unsigned long *)0x40008008))
</span>
<span class="cp">#define DC                      (*((volatile unsigned long *)0x40004100))
#define DC_COMMAND              0
#define DC_DATA                 0x40
</span>
<span class="cp">#define RESET                   (*((volatile unsigned long *)0x40004200))
#define RESET_LOW               0
#define RESET_HIGH              0x80
</span>
<span class="cm">/* ************************* Variables ************************ */</span>

<span class="c1">// Maximum dimensions of the LCD
</span><span class="cp">#define MAX_X                   84
#define MAX_Y                   48
</span>
<span class="c1">// This table contains the hex values that represent pixels
// for a font that is 5 pixels wide and 8 pixels high
</span><span class="k">static</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">ASCII</span><span class="p">[][</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 20
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x5f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 21 !
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 22 "
</span>  <span class="p">,{</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">}</span> <span class="c1">// 23 #
</span>  <span class="p">,{</span><span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">}</span> <span class="c1">// 24 $
</span>  <span class="p">,{</span><span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">}</span> <span class="c1">// 25 %
</span>  <span class="p">,{</span><span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">}</span> <span class="c1">// 26 &amp;
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 27 '
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 28 (
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 29 )
</span>  <span class="p">,{</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">}</span> <span class="c1">// 2a *
</span>  <span class="p">,{</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">}</span> <span class="c1">// 2b +
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 2c ,
</span>  <span class="p">,{</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">}</span> <span class="c1">// 2d -
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 2e .
</span>  <span class="p">,{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">}</span> <span class="c1">// 2f /
</span>  <span class="p">,{</span><span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">}</span> <span class="c1">// 30 0
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 31 1
</span>  <span class="p">,{</span><span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">}</span> <span class="c1">// 32 2
</span>  <span class="p">,{</span><span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">}</span> <span class="c1">// 33 3
</span>  <span class="p">,{</span><span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">}</span> <span class="c1">// 34 4
</span>  <span class="p">,{</span><span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">}</span> <span class="c1">// 35 5
</span>  <span class="p">,{</span><span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">}</span> <span class="c1">// 36 6
</span>  <span class="p">,{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x71</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">}</span> <span class="c1">// 37 7
</span>  <span class="p">,{</span><span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">}</span> <span class="c1">// 38 8
</span>  <span class="p">,{</span><span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">}</span> <span class="c1">// 39 9
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 3a :
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 3b ;
</span>  <span class="p">,{</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 3c &lt;
</span>  <span class="p">,{</span><span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">}</span> <span class="c1">// 3d =
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">}</span> <span class="c1">// 3e &gt;
</span>  <span class="p">,{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">}</span> <span class="c1">// 3f ?
</span>  <span class="p">,{</span><span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">}</span> <span class="c1">// 40 @
</span>  <span class="p">,{</span><span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">}</span> <span class="c1">// 41 A
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">}</span> <span class="c1">// 42 B
</span>  <span class="p">,{</span><span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">}</span> <span class="c1">// 43 C
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">}</span> <span class="c1">// 44 D
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">}</span> <span class="c1">// 45 E
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">}</span> <span class="c1">// 46 F
</span>  <span class="p">,{</span><span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x7a</span><span class="p">}</span> <span class="c1">// 47 G
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">}</span> <span class="c1">// 48 H
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 49 I
</span>  <span class="p">,{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">}</span> <span class="c1">// 4a J
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">}</span> <span class="c1">// 4b K
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">}</span> <span class="c1">// 4c L
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">}</span> <span class="c1">// 4d M
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">}</span> <span class="c1">// 4e N
</span>  <span class="p">,{</span><span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">}</span> <span class="c1">// 4f O
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">}</span> <span class="c1">// 50 P
</span>  <span class="p">,{</span><span class="mh">0x3e</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x5e</span><span class="p">}</span> <span class="c1">// 51 Q
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">}</span> <span class="c1">// 52 R
</span>  <span class="p">,{</span><span class="mh">0x46</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">}</span> <span class="c1">// 53 S
</span>  <span class="p">,{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">}</span> <span class="c1">// 54 T
</span>  <span class="p">,{</span><span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">}</span> <span class="c1">// 55 U
</span>  <span class="p">,{</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">}</span> <span class="c1">// 56 V
</span>  <span class="p">,{</span><span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">}</span> <span class="c1">// 57 W
</span>  <span class="p">,{</span><span class="mh">0x63</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x63</span><span class="p">}</span> <span class="c1">// 58 X
</span>  <span class="p">,{</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">}</span> <span class="c1">// 59 Y
</span>  <span class="p">,{</span><span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">}</span> <span class="c1">// 5a Z
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 5b [
</span>  <span class="p">,{</span><span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">}</span> <span class="c1">// 5c '\'
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 5d ]
</span>  <span class="p">,{</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">}</span> <span class="c1">// 5e ^
</span>  <span class="p">,{</span><span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">}</span> <span class="c1">// 5f _
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 60 `
</span>  <span class="p">,{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">}</span> <span class="c1">// 61 a
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">}</span> <span class="c1">// 62 b
</span>  <span class="p">,{</span><span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">}</span> <span class="c1">// 63 c
</span>  <span class="p">,{</span><span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">}</span> <span class="c1">// 64 d
</span>  <span class="p">,{</span><span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">}</span> <span class="c1">// 65 e
</span>  <span class="p">,{</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">}</span> <span class="c1">// 66 f
</span>  <span class="p">,{</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x3e</span><span class="p">}</span> <span class="c1">// 67 g
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">}</span> <span class="c1">// 68 h
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x7d</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 69 i
</span>  <span class="p">,{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 6a j
</span>  <span class="p">,{</span><span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 6b k
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 6c l
</span>  <span class="p">,{</span><span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">}</span> <span class="c1">// 6d m
</span>  <span class="p">,{</span><span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">}</span> <span class="c1">// 6e n
</span>  <span class="p">,{</span><span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">}</span> <span class="c1">// 6f o
</span>  <span class="p">,{</span><span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">}</span> <span class="c1">// 70 p
</span>  <span class="p">,{</span><span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">}</span> <span class="c1">// 71 q
</span>  <span class="p">,{</span><span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">}</span> <span class="c1">// 72 r
</span>  <span class="p">,{</span><span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">}</span> <span class="c1">// 73 s
</span>  <span class="p">,{</span><span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">}</span> <span class="c1">// 74 t
</span>  <span class="p">,{</span><span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">}</span> <span class="c1">// 75 u
</span>  <span class="p">,{</span><span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">}</span> <span class="c1">// 76 v
</span>  <span class="p">,{</span><span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">}</span> <span class="c1">// 77 w
</span>  <span class="p">,{</span><span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">}</span> <span class="c1">// 78 x
</span>  <span class="p">,{</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">}</span> <span class="c1">// 79 y
</span>  <span class="p">,{</span><span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">}</span> <span class="c1">// 7a z
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 7b {
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 7c |
</span>  <span class="p">,{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">}</span> <span class="c1">// 7d }
</span>  <span class="p">,{</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">}</span> <span class="c1">// 7e ~
//  ,{0x78, 0x46, 0x41, 0x46, 0x78} // 7f DEL
</span>  <span class="p">,{</span><span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">}</span> <span class="c1">// 7f UT sign
</span><span class="p">};</span>

<span class="cm">/* ************************ Prototypes ************************ */</span>

<span class="kt">void</span> <span class="k">static</span> <span class="n">lcd_write_command</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">data</span><span class="p">);</span>
<span class="kt">void</span> <span class="k">static</span> <span class="n">lcd_write_data</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">data</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">spi0_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">nokia5110_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">nokia5110_out_char</span><span class="p">(</span><span class="kt">char</span> <span class="n">data</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">nokia5110_out_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">nokia5110_setcursor</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">newX</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">newY</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">nokia5110_clear</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* *************************** main *************************** */</span>

<span class="kt">int</span> <span class="n">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="n">spi0_init</span> <span class="p">();</span>
  <span class="n">nokia5110_init</span> <span class="p">();</span>
  
  <span class="n">nokia5110_out_string</span><span class="p">(</span><span class="s">"Hello World!"</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* *************************** Functions *************************** */</span>

<span class="c1">// Helper function that sends an 8-bit command to the LCD
</span><span class="kt">void</span> <span class="k">static</span> <span class="n">lcd_write_command</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// wait until SSI0 not busy/transmit FIFO empty
</span>  <span class="k">while</span> <span class="p">((</span><span class="n">SSI0_SR_R</span><span class="o">&amp;</span><span class="mh">0x00000010</span><span class="p">)</span><span class="o">==</span><span class="mh">0x00000010</span><span class="p">){};</span>
  <span class="n">DC</span> <span class="o">=</span> <span class="n">DC_COMMAND</span><span class="p">;</span>
  <span class="n">SSI0_DR_R</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>  <span class="c1">// command out
</span>                     <span class="c1">// wait until SSI0 not busy/transmit FIFO empty
</span>  <span class="k">while</span> <span class="p">((</span><span class="n">SSI0_SR_R</span><span class="o">&amp;</span><span class="mh">0x00000010</span><span class="p">)</span><span class="o">==</span><span class="mh">0x00000010</span><span class="p">){};</span>
<span class="p">}</span>

<span class="c1">// Helper function that sends 8-bit data to the LCD
</span><span class="kt">void</span> <span class="k">static</span> <span class="n">lcd_write_data</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">data</span><span class="p">){</span>
  <span class="k">while</span> <span class="p">((</span><span class="n">SSI0_SR_R</span><span class="o">&amp;</span><span class="mh">0x00000002</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">){};</span> <span class="c1">// wait until transmit FIFO not full
</span>  <span class="n">DC</span> <span class="o">=</span> <span class="n">DC_DATA</span><span class="p">;</span>
  <span class="n">SSI0_DR_R</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>                    <span class="c1">// data out
</span><span class="p">}</span>

<span class="kt">void</span> <span class="n">spi0_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">delay</span><span class="p">;</span>

  <span class="c1">// 1. Enable the SSI module using the RCGCSSI register (see page 346).
</span>  <span class="n">SYSCTL_RCGCSSI_R</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// activate SSI0
</span>  
  <span class="c1">// 2. Enable the clock to the appropriate GPIO module via the RCGCGPIO register (see page 340).
</span>  <span class="c1">//    To find out which GPIO port to enable, refer to Table 23-5 on page 1351.
</span>  <span class="n">SYSCTL_RCGCGPIO_R</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">0</span><span class="p">);</span> <span class="c1">// activate port A
</span>  <span class="n">delay</span> <span class="o">=</span> <span class="n">SYSCTL_RCGCGPIO_R</span><span class="p">;</span>  <span class="c1">// allow time to finish activating
</span>
  <span class="c1">// 3. Set the GPIO AFSEL bits for the appropriate pins (see page 671). To determine which GPIOs to
</span>  <span class="c1">//    configure, see Table 23-4 on page 1344.
</span>  <span class="n">GPIO_PORTA_AFSEL_R</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">);</span> <span class="c1">// enable alt funct on PA2,3,5
</span>  <span class="n">GPIO_PORTA_AFSEL_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">));</span>     <span class="c1">// disable alt funct on PA6,7
</span>
  <span class="c1">// 4. Configure the PMCn fields in the GPIOPCTL register to assign the SSI signals to the appropriate
</span>  <span class="c1">//    pins. See page 688 and Table 23-5 on page 1351.
</span>                                        <span class="c1">// configure PA2,3,5 as SSI
</span>  <span class="n">GPIO_PORTA_PCTL_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">GPIO_PORTA_PCTL_R</span> <span class="o">&amp;</span> <span class="mh">0xFF0F00FF</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x00202200</span><span class="p">;</span>
                                        <span class="c1">// configure PA6,7 as GPIO
</span>  <span class="n">GPIO_PORTA_PCTL_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">GPIO_PORTA_PCTL_R</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFF</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x00000000</span><span class="p">;</span>
  
  <span class="c1">// 5. Program the GPIODEN register to enable the pin's digital function. In addition, the drive strength,
</span>  <span class="c1">//    drain select and pull-up/pull-down functions must be configured. Refer to “General-Purpose
</span>  <span class="c1">//    Input/Outputs (GPIOs)” on page 649 for more information.
</span>  <span class="n">GPIO_PORTA_DIR_R</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>                             <span class="c1">// make PA6,7 out  
</span>  <span class="n">GPIO_PORTA_DEN_R</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">);</span>        <span class="c1">// enable digital I/O on PA2,3,5,6,7
</span>  <span class="n">GPIO_PORTA_AMSEL_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">3</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">))</span> <span class="p">;</span>  <span class="c1">// disable analog functionality on PA2,3,5,6,7
</span>  
  <span class="c1">//
</span>  <span class="c1">//For each of the frame formats, the SSI is configured using the following steps:
</span>  
  <span class="c1">// 1. Ensure that the SSE bit in the SSICR1 register is clear before making any configuration changes.
</span>  <span class="n">SSI0_CR1_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// disable SSI
</span>  
  <span class="c1">// 2. Select whether the SSI is a master or slave:
</span>  <span class="c1">//    a. For master operations, set the SSICR1 register to 0x0000.0000.
</span>  <span class="c1">//    b. For slave mode (output enabled), set the SSICR1 register to 0x0000.0004.
</span>  <span class="c1">//    c. For slave mode (output disabled), set the SSICR1 register to 0x0000.000C.
</span>  <span class="n">SSI0_CR1_R</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="c1">// we choose (a) as the uC is the master
</span>
  <span class="c1">// 3. Configure the SSI clock source by writing to the SSICC register.
</span>  <span class="n">SSI0_CC_R</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span> <span class="c1">// select system clock as the clock input to the SSI module.
</span>  
  <span class="c1">// 4. Configure the clock prescale divisor by writing the SSICPSR register. 
</span>  <span class="c1">// Bit Rate = SysClk / (CPSDVSR * (1 + SCR))
</span>  <span class="c1">//          = 16000000 / (16 x (1+0))
</span>  <span class="c1">//          = 1000000 KHz = 1 MHz
</span>  <span class="c1">// So, CPSDVSR = 16 decimal = 0x10
</span>  <span class="c1">//         SCR = 0 decimal
</span>  <span class="n">SSI0_CPSR_R</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> 

  <span class="c1">// 5. Write the SSICR0 register with the following configuration:
</span>  <span class="c1">//    + Serial clock rate (SCR) (bits 8:15)
</span>  <span class="c1">//    + Desired clock phase/polarity, if using Freescale SPI mode (SPH (bit 6) and SPO (bit 7))
</span>  <span class="c1">//    + The protocol mode: Freescale SPI, TI SSF, MICROWIRE (FRF)
</span>  <span class="c1">//    + The data size (DSS)
</span>  
  <span class="n">SSI0_CR0_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x0000FF00</span><span class="p">);</span>  <span class="c1">// SCR = 0 
</span>  <span class="n">SSI0_CR0_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x00000040</span><span class="p">);</span>  <span class="c1">// SPO = 0 
</span>  <span class="n">SSI0_CR0_R</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x00000080</span><span class="p">);</span>  <span class="c1">// SPH = 0                 
</span>	
  <span class="n">SSI0_CR0_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">SSI0_CR0_R</span><span class="o">&amp;~</span><span class="mh">0x00000030</span><span class="p">)</span><span class="o">+</span><span class="mh">0x00000000</span><span class="p">;</span> <span class="c1">// FRF = Freescale format                                       
</span>  <span class="n">SSI0_CR0_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">SSI0_CR0_R</span><span class="o">&amp;~</span><span class="mh">0x0000000F</span><span class="p">)</span><span class="o">+</span><span class="mh">0x00000007</span><span class="p">;</span> <span class="c1">// DSS = 8-bit data
</span>  
  <span class="c1">// 6. Optionally, configure the SSI module for ?DMA use with the following steps:
</span>  <span class="c1">//    a. Configure a ?DMA for SSI use. See “Micro Direct Memory Access (?DMA)” on page 585 for
</span>  <span class="c1">//       more information.
</span>  <span class="c1">//    b. Enable the SSI Module's TX FIFO or RX FIFO by setting the TXDMAE or RXDMAE bit in the
</span>  <span class="c1">//       SSIDMACTL register.
</span>
  <span class="c1">// 7. Enable the SSI by setting the SSE bit in the SSICR1 register.
</span>  <span class="n">SSI0_CR1_R</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">nokia5110_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="k">volatile</span> <span class="kt">uint32_t</span> <span class="n">delay</span><span class="p">;</span>
  
  <span class="n">RESET</span> <span class="o">=</span> <span class="n">RESET_LOW</span><span class="p">;</span>                     <span class="c1">// reset the LCD to a known state
</span>  <span class="k">for</span><span class="p">(</span><span class="n">delay</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">delay</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="n">delay</span><span class="o">=</span><span class="n">delay</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// delay minimum 100 ns
</span>  <span class="n">RESET</span> <span class="o">=</span> <span class="n">RESET_HIGH</span><span class="p">;</span>                    <span class="c1">// negative logic
</span>
  <span class="n">lcd_write_command</span><span class="p">(</span><span class="mh">0x21</span><span class="p">);</span>               <span class="c1">// chip active; horizontal addressing mode (V = 0); use extended instruction set (H = 1)
</span>                                         <span class="c1">// set LCD Vop (contrast), which may require some tweaking:
</span>  <span class="n">lcd_write_command</span><span class="p">(</span><span class="mh">0xB1</span><span class="p">);</span>               <span class="c1">// 0xB1 (for 3.3V red SparkFun)
</span>  <span class="n">lcd_write_command</span><span class="p">(</span><span class="mh">0x04</span><span class="p">);</span>               <span class="c1">// set temp coefficient
</span>  <span class="n">lcd_write_command</span><span class="p">(</span><span class="mh">0x14</span><span class="p">);</span>               <span class="c1">// LCD bias mode 1:48: try 0x13 or 0x14
</span>
  <span class="n">lcd_write_command</span><span class="p">(</span><span class="mh">0x20</span><span class="p">);</span>               <span class="c1">// we must send 0x20 before modifying the display control mode
</span>  <span class="n">lcd_write_command</span><span class="p">(</span><span class="mh">0x0C</span><span class="p">);</span>               <span class="c1">// set display control to normal mode: 0x0D for inverse
</span><span class="p">}</span>

<span class="c1">// Print a character to the Nokia 5110 48x84 LCD.  The
// character will be printed at the current cursor position,
// the cursor will automatically be updated, and it will
// wrap to the next row or back to the top if necessary.
// One blank column of pixels will be printed on either side
// of the character for readability.  Since characters are 8
// pixels tall and 5 pixels wide, 12 characters fit per row,
// and there are six rows.
</span><span class="kt">void</span> <span class="n">nokia5110_out_char</span><span class="p">(</span><span class="kt">char</span> <span class="n">data</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="n">lcd_write_data</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>        <span class="c1">// blank vertical line padding
</span>  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">){</span>
    <span class="n">lcd_write_data</span><span class="p">(</span><span class="n">ASCII</span><span class="p">[</span><span class="n">data</span> <span class="o">-</span> <span class="mh">0x20</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">lcd_write_data</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>        <span class="c1">// blank vertical line padding
</span><span class="p">}</span>

<span class="c1">// Print a string of characters to the Nokia 5110 48x84 LCD.
// The string will automatically wrap, so padding spaces may
// be needed to make the output look optimal.
</span><span class="kt">void</span> <span class="n">nokia5110_out_string</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">){</span>
  <span class="k">while</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">){</span>
    <span class="n">nokia5110_out_char</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span><span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Move the cursor to the desired X- and Y-position.  The
// next character will be printed here.  X=0 is the leftmost
// column.  Y=0 is the top row.
</span><span class="kt">void</span> <span class="n">nokia5110_setcursor</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">newX</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">newY</span><span class="p">){</span>
  <span class="k">if</span><span class="p">((</span><span class="n">newX</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">newY</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)){</span>        <span class="c1">// bad input
</span>    <span class="k">return</span><span class="p">;</span>                             <span class="c1">// do nothing
</span>  <span class="p">}</span>
  <span class="c1">// multiply newX by 7 because each character is 7 columns wide
</span>  <span class="n">lcd_write_command</span><span class="p">(</span><span class="mh">0x80</span><span class="o">|</span><span class="p">(</span><span class="n">newX</span><span class="o">*</span><span class="mi">7</span><span class="p">));</span>     <span class="c1">// setting bit 7 updates X-position
</span>  <span class="n">lcd_write_command</span><span class="p">(</span><span class="mh">0x40</span><span class="o">|</span><span class="n">newY</span><span class="p">);</span>         <span class="c1">// setting bit 6 updates Y-position
</span><span class="p">}</span>

<span class="c1">// Clear the LCD by writing zeros to the entire screen and
// reset the cursor to (0,0) (top left corner of screen).
</span><span class="kt">void</span> <span class="n">nokia5110_clear</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="p">(</span><span class="n">MAX_X</span><span class="o">*</span><span class="n">MAX_Y</span><span class="o">/</span><span class="mi">8</span><span class="p">);</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">){</span>
    <span class="n">lcd_write_data</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">nokia5110_setcursor</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</code></pre>
</div>
<hr />

<h2><a href=""></a> مراجع</h2>

<ul>
  <li><a href="https://www.e-tinkers.com/2017/11/how-to-use-lcd-5110-pcd-8544-with-arduino">https://www.e-tinkers.com/2017/11/how-to-use-lcd-5110-pcd-8544-with-arduino</a></li>
</ul>

</p>

    <blockquote class="post_ending_note">
        <p><strong>ملاحظة</strong>: هذه المقالة تحت التحديث المستمر،، وملاحظاتكم وإقتراحاتكم ستساعد بإذن الله في إخراجها بالصورة التي كتبت من أجلها وهي تمهيد الطريق أمامكم لتعلم برمجة الأنظمة المدمجة </p>
    </blockquote>

    <hr>
      
          <a class="prev" href="/2018/08/17/i2c.html">13. بروتوكول الإتصال المتزامن I2C</a> <br>
      
      
          <a class="next" href="/2018/07/06/uart.html">11. بروتوكول الإتصال الغير متزامن UART</a> <br>
      
    <br>
    <hr>

<br>




<div id="disqus_thread"></div>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = "http://localhost:4000/2018/07/18/spi.html";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = "/2018/07/18/spi"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://embedded-course.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            


      </section>
<!--      
      <footer>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
-->
    </div>
    <script src="/assets/js/scale.fix.js"></script>
    <!--<script type="text/javascript" src="/assets/js/staticman.js"></script>-->

  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-106571814-1', 'auto');
        ga('send', 'pageview');
    </script>
  
  </body>
</html>
