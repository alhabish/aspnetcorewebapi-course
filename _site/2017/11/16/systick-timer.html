<!doctype html>
<html dir="rtl" lang="ar-SA">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">

<!-- Begin Jekyll SEO tag v2.3.0 -->
<title>مؤقت النظام SysTick Timer | لنتعلم برمجة الأنظمة المدمجة</title>
<meta property="og:title" content="مؤقت النظام SysTick Timer" />
<meta name="author" content="خالد الغامدي" />
<meta property="og:locale" content="ar_SA" />
<meta name="description" content="يساعدنا مؤقت النظام SystTick في حساب الوقت والتعامل مع بعض الإجراءات التي تحتاج الى الوقت للتحكم بها ولتنفيذ بعض الوظائف كلما مرت فتره معينة محددة مسبقاً. وبالإمكان إستخدام هذا المؤقت لو كان لديك نظام تشغيل مثلاً يتنقل في التنفيذ بين أكثر من thread. وسيناريو آخر لإستخدامها هو لحساب الزمن ولقياس المدة التي يستغرقها الكود في التنفيذ." />
<meta property="og:description" content="يساعدنا مؤقت النظام SystTick في حساب الوقت والتعامل مع بعض الإجراءات التي تحتاج الى الوقت للتحكم بها ولتنفيذ بعض الوظائف كلما مرت فتره معينة محددة مسبقاً. وبالإمكان إستخدام هذا المؤقت لو كان لديك نظام تشغيل مثلاً يتنقل في التنفيذ بين أكثر من thread. وسيناريو آخر لإستخدامها هو لحساب الزمن ولقياس المدة التي يستغرقها الكود في التنفيذ." />
<link rel="canonical" href="http://localhost:4000/2017/11/16/systick-timer.html" />
<meta property="og:url" content="http://localhost:4000/2017/11/16/systick-timer.html" />
<meta property="og:site_name" content="لنتعلم برمجة الأنظمة المدمجة" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-11-16T00:00:00+03:00" />
<script type="application/ld+json">
{"name":null,"description":"يساعدنا مؤقت النظام SystTick في حساب الوقت والتعامل مع بعض الإجراءات التي تحتاج الى الوقت للتحكم بها ولتنفيذ بعض الوظائف كلما مرت فتره معينة محددة مسبقاً. وبالإمكان إستخدام هذا المؤقت لو كان لديك نظام تشغيل مثلاً يتنقل في التنفيذ بين أكثر من thread. وسيناريو آخر لإستخدامها هو لحساب الزمن ولقياس المدة التي يستغرقها الكود في التنفيذ.","author":{"@type":"Person","name":"خالد الغامدي"},"@type":"BlogPosting","url":"http://localhost:4000/2017/11/16/systick-timer.html","publisher":null,"image":null,"headline":"مؤقت النظام SysTick Timer","dateModified":"2017-11-16T00:00:00+03:00","datePublished":"2017-11-16T00:00:00+03:00","sameAs":null,"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2017/11/16/systick-timer.html"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->


    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <script type="text/javascript" src="/assets/js/jquery-1.12.4.min.js" ></script>
    <script type="text/javascript" src="/assets/js/main.js"></script>
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>لنتعلم برمجة الأنظمة المدمجة</h1>
		<h3 text-align="left">Embedded Systems Programming Bootcamp</h3>
        <p>كورس تعليمي يهدف الى اكسابك المعرفة اللازمة والمهارات التقنية المتعلقة ببرمجة وتطوير الأنظمة المدمجة وفهم خصائصها ومكوناتها</p>
        <p class="view">
            <a href="/">الصفحة الرئيسية</a><br>
            <!--<a href="/#contents">الدروس</a><br>-->
            <a href="/lessons.html">قائمة الدروس</a><br>
            <a href="/feed.xml" title="Subscribe to our RSS feed">خدمة RSS</a>
        </p>
        <!--/assets/images/sidebar/rss.svg-->
          <!--<aside>-->
    <h3>للتواصل</h3>
    <ul class="social">
    <li><a href="https://github.com/alhabish/embedded-course" title="Github" class="github">Github</a></li>
    <li><a href="mailto:alhabish@gmail.com" title="Email" class="mail">Email</a></li>
    <li><a href="https://www.linkedin.com/in/khalidalghamidi" title="Linked in" class="linked">LinkedIn</a></li>
    <li><a href="http://www.twitter.com/alhabish" title="Twitter" class="twitter">Twitter</a></li>
    </ul>
    <!--</aside>-->
          
<!--        
        

        

        
-->
      </header>
      <section>

      <h1>9. مؤقت النظام  SysTick Timer</h1>
<p class="meta">2017-11-16</p>


<!-- from https://github.com/cstack/db_tutorial -->


      
      

    <hr>
      
          <a class="prev" href="/2018/06/20/pll.html">10. Phased Lock Loop - PLL</a> <br>
      
      
          <a class="next" href="/2017/11/09/working-with-switches.html">8. التعامل مع الأزرار Switches</a> <br>
      
    <br>
    <hr>

    <p><p>يساعدنا مؤقت النظام SystTick في حساب الوقت والتعامل مع بعض الإجراءات التي تحتاج الى الوقت للتحكم بها ولتنفيذ بعض الوظائف كلما مرت فتره معينة محددة مسبقاً. وبالإمكان إستخدام هذا المؤقت لو كان لديك نظام تشغيل مثلاً يتنقل في التنفيذ بين أكثر من thread. وسيناريو آخر لإستخدامها هو لحساب الزمن ولقياس المدة التي يستغرقها الكود في التنفيذ.</p>

<p>يوجد في المتحكم مؤقتات أخرى غير الـ SysTick بعضها يدعم 32 بت وأخرى 64 بت. وبالرغم أن SysTick الأقل دقة بينهم حيث أنه لا يدعم سوى 24 بت إلا أنه الأسهل في التعامل بالإضافة الى أنه المؤقت الوحيد المعتمد في ARM Cortex-M وبذلك فلو أردت تغير المتحكم هذا واستخدام متحكم آخر من نفس العائلة فإنك لن تحتاج الى تغييره بينما المؤقتات الأخرى خاصة بكل نوع متحكم على حده.</p>

<p>ويتكون هذا المؤقت من 24 بت (أي أن أقصى رقم يمكن إسناده اليه هو 0xFFFFFF) تتناقص مع كل clock tick الى أن تصل الى 0 ومن ثم يعاد العد مرة أخرى.</p>

<hr />
<h1><a href=""></a>السجلات المتعلقة بهذا المؤقت</h1>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_09/systick_registers.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_09/systick_registers.png');" />
    </td>
</tr>
</table>

<p>يتكون المؤقت من 3 سجلات:</p>
<ul>
  <li><strong>STCTRL</strong> أو SysTick Control and Status وتستخدم لتهيئة المؤقت ولتفعيله والتحكم به.</li>
  <li><strong>STRELOAD</strong> أو SysTick Reload Value ويسند اليه القيمة التي يبدأ العداد بالتناقص منها.</li>
  <li><strong>STCURRENT</strong> أو SysTick Current Value وتحتوي على القيمة الحالية للعداد.</li>
</ul>

<h2><a href=""></a>1. السجل STCTRL</h2>

<p>تفصيل هذا السجل في دليل البيانات data sheet ص 138:</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_09/stctrl.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_09/stctrl.png');" />
    </td>
</tr>
</table>

<p>وما يهمنا في هذا السجل البتات bits التالية:</p>
<ul>
  <li><strong>bit 0</strong> وهي الـ Enable والتي تقوم بتفعيل عمل المؤقت</li>
  <li><strong>bit 1</strong> وهي الـ Interrupt Enable والتي تفعّل المقاطعات interrupts (المزيد عنها لاحقاً بإذن الله)</li>
  <li><strong>bit 2</strong> وهي الـ Clock Selection وفي العادة نختار الساعة القياسية هنا</li>
  <li><strong>bit 16</strong> وهي الـ  Count Flag وتكون 1 كلما تناقص العداد ووصل للصفر ثم عاد للعدد من جديد</li>
</ul>

<h2><a href=""></a>2. السجل STRELOAD</h2>

<p>في دليل البيانات ص 140 نجد تفاصيل السجل:</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_09/streload.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_09/streload.png');" />
    </td>
</tr>
</table>

<p>نستخدم أول 24 بت فقط (من بت 0 الى 23) من هذا السجل لكتابة قيمة العدد الذي نرغب من المؤقت أن يبدأ بالتناقص منه.</p>

<h2><a href=""></a>3. السجل STCURRENT</h2>

<p>في دليل البيانات ص 141 نجد:</p>

<table style="border: 1px solid #CACFD2">


<tr>
    <td style="text-align:center; align:center">
        <img src="http://localhost:4000/assets/files/article_09/stcurrent.png" alt="" style="cursor: pointer;" onclick="openInNewTab('http://localhost:4000/assets/files/article_09/stcurrent.png');" />
    </td>
</tr>
</table>

<p>يحتوي هذا السجل على القيمة الحالية للعداد. ومثل السجل السابق، نستخدم أول 24 بت فقط من هذا السجل أي أن قيمة العداد لا يمكن أن تزيد عن 0xFFFFFF. العداد تنازلي أي أنه يعد من العدد الأصلي الذي تم إسناده اليه ويتناقص بمقدار 1 الى أن يصل 0 بمقدار سرعة الساعة المختارة. بعد ذلك يسند 1 الى بت 16 في سجل الـ STCTRL ثم يأخذ القيمة الموجودة في سجل الـ STRELOAD مرة أخرى وينسخها الى سجل الـ STCURRENT.</p>

<hr />
<h1><a href=""></a>تهيئة المؤقت</h1>

<p>هنالك عدة خطوات للقيام بذلك، وهي:</p>

<ol>
  <li><strong>إيقاف عمل المؤقت بينما نقوم بتهيئته</strong>
    <ul>
      <li>في السجل STCTRL نجعل bit 0 وهي الـ Enable تساوي 0 لإيقاف الـ SysTick بينما نقوم بعملية التهيئة.</li>
    </ul>
  </li>
  <li><strong>إسناد قيمة إبتدائية</strong>
    <ul>
      <li>نقوم بإسناد قيمة يستخدمها المؤقت ليبدأ عملية التناقص منها. وذلك يكون عن طريق السجل STRELOAD.</li>
    </ul>
  </li>
  <li><strong>تصفير العداد</strong>
    <ul>
      <li>نقوم بكتابة أي قيمة الى STCURRENT لجعلها تساوي 0.</li>
    </ul>
  </li>
  <li><strong>تفعيل العداد</strong>
    <ul>
      <li>وذلك يكون عن طريق التعديل على سجل STCTRL بكتابة ما يلي:
        <ul>
          <li>0 في bit 1 وهي الـ Interrupt bit لإلغاء الـمقاطعات interrupts أو 1 لتفعيلها</li>
          <li>1 في bit 2 وهي الـ Clock Source bit لنختار أن يكون مصدر المؤقت هو الساعة القياسية على البورد التي يستخدمها المعالج cpu وجميع الطرفيات peripherals والتي تبلغ سرعتها 16MHz</li>
          <li>1 في bit 0 وهي الـ Enable bit لتفعيل العداد</li>
        </ul>
      </li>
    </ul>
  </li>
</ol>

<p>بعد ذلك سيبدأ المؤقت في العد التنازلي بإنقاص العدد الموجود في سجل الـ STCURRENT بمقدار 1 في كل دورة للساعة clock cycle وكتابة القيمة هذه مجدداً الى السجل ذاته. وبما أن الساعة التي أخترناها سرعتها 16MHz فذلك يعني أن تنفيذ أي أمر instruction - وهي إنقاص القيمة بمقدار 1 هنا - ستستغرق 62.5ns</p>

<div class="highlighter-rouge"><pre class="highlight"><code>1/16000000 = 0.0000000625 seconds = 62.5 nanoseconds
</code></pre>
</div>

<p>وبما أن حجم العداد هو 24 بت فإن أقصى عدد يمكن إستخدامه للعداد هو 0x00FFFFFF.
فلو أخترنا أن يبدأ العداد من الرقم 16,000,000 فالذي علينا القيام به هو إسناد هذه القيمة الى السجل RELOAD أولاً ثم عندما نطلب من العداد البدء فإن المتحكم ينسخ قيمة السجل السابق ويضعها في السجل STCURRENT. وبما أن سرعة الساعة 16MHz فذلك يعني أن العداد سيبدأ من هذا الرقم ويتناقص رقماً كل 62.5ns الى أن يصل الى 0 في مدة زمنية قدرها ثانية واحدة. وحينما يصل العداد الى صفر يقوم المتحكم بنسخ القيمة الموجودة في STRELOAD الى السجل STCURRENT وكتابة 1 الى bit 16 في STCTRL  ليوضح بأننا سنقوم بالعد مرة أخرى ثم القيام بالعد من جديد.</p>

<h2><a href=""></a>ملاحظة</h2>

<ul>
  <li>اذا أعاد اليك الـ Count Flag القيمة 0 فذلك يعني أن العداد لم يصل الى الصفر منذ آخر مرة تم فيها قراءة هذا البت</li>
  <li>إذا أعاد اليك الـ Count Flag القيمة 1 فإنه يعني بأن العداد وصل الى الصفر منذ آخر مرة تم فيها قراءة هذا البت وبعد هذه القرائة سيصبح 0</li>
  <li>كتابة أي قيمة الى سجل STCURRENT سيقوم بتصفير العداد وتصفير البت 16 في سجل الـ STCTRL</li>
</ul>

<hr />
<h1><a href=""></a>برنامج لقياس سرعة التنفيذ</h1>

<p>فيما يلي برنامج يستفيد من المؤقت SysTick لقياس المدة الزمنية التي يستغرقها جزء من البرنامج في التنفيذ:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code>
<span class="cm">/* ************************* Registers ************************ */</span>

<span class="cp">#define STCTRL_R      (*((volatile unsigned long *)0xE000E010))
#define STRELOAD_R    (*((volatile unsigned long *)0xE000E014))
#define STCURRENT_R   (*((volatile unsigned long *)0xE000E018))
</span>

<span class="cm">/* ************************ STCTRL Bits *********************** */</span>

<span class="cp">#define STCTRL_BIT_ENABLE   0
#define STCTRL_BIT_INTEN    1
#define STCTRL_BIT_CLKSRC   2
#define STCTRL_BIT_COUNT    16
</span>
<span class="cm">/* *************************** main *************************** */</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Initialize SysTick
</span>  <span class="c1">//
</span>  <span class="n">STCTRL_R</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">0U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_ENABLE</span><span class="p">);</span>    <span class="c1">// 1) disable SysTick during setup
</span>  <span class="n">STRELOAD_R</span>  <span class="o">=</span> <span class="mh">0x00FFFFFF</span><span class="p">;</span>                   <span class="c1">// 2) maximum reload value
</span>  <span class="n">STCURRENT_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                            <span class="c1">// 3) any write to current clears it
</span>  
  <span class="n">STCTRL_R</span>   <span class="o">|=</span> <span class="p">((</span><span class="mi">0U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_INTEN</span><span class="p">)</span>  <span class="o">|</span>  <span class="c1">// 4.1) disable interrupts
</span>                 <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_CLKSRC</span><span class="p">)</span> <span class="o">|</span>  <span class="c1">// 4.2) enable core bus clock
</span>                 <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_ENABLE</span><span class="p">));</span>  <span class="c1">// 4.3) enable SysTick 
</span>  
  <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">current_time</span><span class="p">;</span>  
  <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_time</span><span class="p">;</span>     
  <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">elapsed_time</span><span class="p">;</span>  
  <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">current_time</span> <span class="o">=</span> <span class="n">STCURRENT_R</span><span class="p">;</span>
    <span class="n">sum</span> <span class="o">++</span><span class="p">;</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">last_time</span><span class="o">-</span><span class="n">current_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFF</span><span class="p">;</span> <span class="c1">// 24-bit difference
</span>    <span class="n">last_time</span> <span class="o">=</span> <span class="n">current_time</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</code></pre>
</div>

<p>أو قم بنسخه من الرابط التالي:</p>

<p><a href="https://github.com/alhabish/embedded-course/blob/gh-pages/assets/files/article_09/measure_elapsed_time.c">https://github.com/alhabish/embedded-course/blob/gh-pages/assets/files/article_09/measure_elapsed_time.c</a></p>

<p>يجب التنويه الى أن القراءة الأولى ستكون خاطئة لأننا نقيس الوقت بناءاً على القياسات السابقة وفي هذه الحالة لن يكون هناك قياس سابق للزمن.</p>

<p>وما نقوم به في السطر التالي:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>elapsed_time = (last_time-current_time) &amp; 0x00FFFFFF; // 24-bit difference
</code></pre>
</div>

<p>هو لأن المتغيرات current_time و last_time وناتج عملية إنقاصهم من بعض هي قيم من نوع 32 بت ولكننا نحتاج الى أول 24 بت منها فقط لأن المؤقت من نوع 24 بت.</p>

<hr />
<h1><a href=""></a>برنامج لإيقاف التنفيذ بشكل دقيق Precise Delays</h1>

<p>في برامجنا السابقة كتبنا دالة delay لإيقاف تنفيذ البرنامج لمدة زمنية عشوائية. ولكن اذا ما أردنا الإنتظار لمدة زمنية محددة وبشكل دقيق فإننا نستخدم الـ systick كما هو في البرنامج التالي:</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code>
<span class="cm">/* ************************* Registers ************************ */</span>

<span class="cp">#define STCTRL_R      (*((volatile unsigned long *)0xE000E010))
#define STRELOAD_R    (*((volatile unsigned long *)0xE000E014))
#define STCURRENT_R   (*((volatile unsigned long *)0xE000E018))
</span>
<span class="cm">/* ************************ STCTRL Bits *********************** */</span>

<span class="cp">#define STCTRL_BIT_ENABLE   0
#define STCTRL_BIT_INTEN    1
#define STCTRL_BIT_CLKSRC   2
#define STCTRL_BIT_COUNT    16
</span>
<span class="cm">/* ************************ Prototypes ************************ */</span>

<span class="kt">void</span> <span class="n">systick_delay_ms</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ms</span><span class="p">);</span>

<span class="cm">/* *************************** main *************************** */</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Initialize SysTick
</span>  <span class="c1">//
</span>  <span class="n">STCTRL_R</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">0U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_ENABLE</span><span class="p">);</span>    <span class="c1">// 1) disable SysTick during setup
</span>  <span class="n">STRELOAD_R</span>  <span class="o">=</span> <span class="mh">0x00FFFFFF</span><span class="p">;</span>                   <span class="c1">// 2) maximum reload value
</span>  <span class="n">STCURRENT_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                            <span class="c1">// 3) any write to current clears it
</span>  
  <span class="n">STCTRL_R</span>   <span class="o">|=</span> <span class="p">((</span><span class="mi">0U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_INTEN</span><span class="p">)</span>  <span class="o">|</span>  <span class="c1">// 4.1) disable interrupts
</span>                 <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_CLKSRC</span><span class="p">)</span> <span class="o">|</span>  <span class="c1">// 4.2) enable core bus clock
</span>                 <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_ENABLE</span><span class="p">));</span>  <span class="c1">// 4.3) enable SysTick 
</span>  
  <span class="c1">// Wait for 0.5 second
</span>  <span class="n">systick_delay_ms</span> <span class="p">(</span><span class="mi">500</span><span class="p">);</span>
  
  <span class="c1">// Wait for 1 second
</span>  <span class="n">systick_delay_ms</span> <span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">systick_delay_ms</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ms</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// 1 period = (real_time_delay in seconds) * (16,000,000 Hz)
</span>  <span class="c1">//          = (1/1000 seconds) * (16,000,000 Hz) 
</span>  <span class="c1">//          = 16,000
</span>  <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">period</span> <span class="o">=</span> <span class="mi">16000</span><span class="p">;</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ms</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">STRELOAD_R</span> <span class="o">=</span> <span class="p">(</span><span class="n">period</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FFFFFF</span><span class="p">;</span> <span class="c1">// 24-bit difference
</span>    <span class="n">STCURRENT_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="c1">// wait until COUNT is flagged
</span>    <span class="k">while</span> <span class="p">((</span><span class="n">STCTRL_R</span> <span class="o">&amp;</span> <span class="mh">0x00010000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>أو قم بنسخه من الرابط التالي:</p>

<p><a href="https://github.com/alhabish/embedded-course/blob/gh-pages/assets/files/article_09/systick_accurate_delay.c">https://github.com/alhabish/embedded-course/blob/gh-pages/assets/files/article_09/systick_accurate_delay.c</a></p>

<p>أرجوا التنويه الى أنه في السطر التالي:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>STRELOAD_R = (period - 1) &amp; 0x00FFFFFF; // 24-bit difference
</code></pre>
</div>

<p>نسند القيمة - 1 الى STRELOAD حيث أن العداد يعد الى أن يصل الى 0 وليس الى 1.</p>

<hr />
<h1><a href=""></a>برنامج لتشغيل/إيقاف تشغيل الإضاءة بشكل دوري</h1>

<p>البرنامج التالي يستخدم SysTick لتشغيل الإضاءة الحمراء لمدة ثانية وإطفائها في الثانية التي تليها والإستمرار على ذلك. وبما أن سرعة الساعة المختارة هي 16MHz فإنه في كل ثانية سيكون لدينا 16,000,000 ذبذبة، وبما أن العداد يتناقص الى الصفر وليس الى الواحد فإننا نقوم بإسناد هذا الرقم ناقص واحد الى سجل الـ STRELOAD.</p>

<div class="language-c highlighter-rouge"><pre class="highlight"><code>
<span class="cm">/* ************************* Registers ************************ */</span>

<span class="cp">#define STCTRL_R      (*((volatile unsigned long *)0xE000E010))
#define STRELOAD_R    (*((volatile unsigned long *)0xE000E014))
#define STCURRENT_R   (*((volatile unsigned long *)0xE000E018))
</span>
<span class="cp">#define SYSCTL_RCGCGPIO_R   (*((volatile unsigned long *)0x400FE608))
#define GPIO_PORTF_DATA_R   (*((volatile unsigned long *)0x400253FC))
#define GPIO_PORTF_DIR_R    (*((volatile unsigned long *)0x40025400))
#define GPIO_PORTF_PUR_R    (*((volatile unsigned long *)0x40025510))
#define GPIO_PORTF_DEN_R    (*((volatile unsigned long *)0x4002551C))
#define GPIO_PORTF_LOCK_R   (*((volatile unsigned long *)0x40025520))
#define GPIO_PORTF_CR_R     (*((volatile unsigned long *)0x40025524))
</span>
<span class="cm">/* ************************ STCTRL Bits *********************** */</span>

<span class="cp">#define STCTRL_BIT_ENABLE   0
#define STCTRL_BIT_INTEN    1
#define STCTRL_BIT_CLKSRC   2
#define STCTRL_BIT_COUNT    16
</span>
<span class="cp">#define LED_RED    (1U &lt;&lt; 1)	
</span>
<span class="cm">/* ************************ Prototypes ************************ */</span>

<span class="kt">void</span> <span class="n">portf_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">systick_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="cm">/* *************************** main *************************** */</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">portf_init</span> <span class="p">();</span>
  <span class="n">systick_init</span> <span class="p">();</span>
  
  <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">STCTRL_R</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* is COUNT flag set? */</span>
        <span class="n">GPIO_PORTF_DATA_R</span> <span class="o">^=</span> <span class="n">LED_RED</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>	
  
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">portf_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wait</span><span class="p">;</span>
  
  <span class="c1">// Initialize clock
</span>  <span class="n">SYSCTL_RCGCGPIO_R</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span> <span class="c1">// 0010 0000  
</span>  <span class="n">wait</span> <span class="o">=</span> <span class="n">SYSCTL_RCGCGPIO_R</span><span class="p">;</span> 
    
  <span class="c1">// Set pin direction
</span>  <span class="n">GPIO_PORTF_DIR_R</span>  <span class="o">=</span> <span class="n">LED_RED</span><span class="p">;</span>

  <span class="c1">// Enable pins
</span>  <span class="n">GPIO_PORTF_DEN_R</span>  <span class="o">=</span> <span class="n">LED_RED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">systick_init</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">STCTRL_R</span>    <span class="o">=</span> <span class="p">(</span><span class="mi">0U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_ENABLE</span><span class="p">);</span>    <span class="c1">// 1) disable SysTick during setup
</span>  <span class="n">STRELOAD_R</span>  <span class="o">=</span> <span class="mi">16000000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>                 <span class="c1">// 2) maximum reload value
</span>  <span class="n">STCURRENT_R</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>                            <span class="c1">// 3) any write to current clears it
</span>  
  <span class="n">STCTRL_R</span>   <span class="o">|=</span> <span class="p">((</span><span class="mi">0U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_INTEN</span><span class="p">)</span>  <span class="o">|</span>  <span class="c1">// 4.1) disable interrupts
</span>                 <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_CLKSRC</span><span class="p">)</span> <span class="o">|</span>  <span class="c1">// 4.2) enable core bus clock
</span>                 <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">STCTRL_BIT_ENABLE</span><span class="p">));</span>  <span class="c1">// 4.3) enable SysTick 
</span><span class="p">}</span>

</code></pre>
</div>

<p>أو قم بنسخه من الرابط التالي:</p>

<p><a href="https://github.com/alhabish/embedded-course/blob/gh-pages/assets/files/article_09/periodic_toggle_led.c">https://github.com/alhabish/embedded-course/blob/gh-pages/assets/files/article_09/periodic_toggle_led.c</a></p>

<hr />
</p>

    <blockquote class="post_ending_note">
        <p><strong>ملاحظة</strong>: هذه المقالة تحت التحديث المستمر،، وملاحظاتكم وإقتراحاتكم ستساعد بإذن الله في إخراجها بالصورة التي كتبت من أجلها وهي تمهيد الطريق أمامكم لتعلم برمجة الأنظمة المدمجة </p>
    </blockquote>

    <hr>
      
          <a class="prev" href="/2018/06/20/pll.html">10. Phased Lock Loop - PLL</a> <br>
      
      
          <a class="next" href="/2017/11/09/working-with-switches.html">8. التعامل مع الأزرار Switches</a> <br>
      
    <br>
    <hr>

<br>




<div id="disqus_thread"></div>
<script>
/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = "http://localhost:4000/2017/11/16/systick-timer.html";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = "/2017/11/16/systick-timer"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://embedded-course.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            


      </section>
<!--      
      <footer>
        
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
-->
    </div>
    <script src="/assets/js/scale.fix.js"></script>
    <!--<script type="text/javascript" src="/assets/js/staticman.js"></script>-->

  
    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-106571814-1', 'auto');
        ga('send', 'pageview');
    </script>
  
  </body>
</html>
